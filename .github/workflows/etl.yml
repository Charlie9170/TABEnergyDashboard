name: ETL Data Updates

# Run every 6 hours and allow manual triggering
on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours at :00
  workflow_dispatch:  # Allow manual runs

# Grant write permissions to commit data files
permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ” Diagnostic - Check API Key Access
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” API Key Diagnostics"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Check if secret exists (will be empty if not set)
          SECRET_LENGTH="${#EIA_API_KEY_SECRET}"
          
          # Check if variable exists (will be empty if not set)
          VARIABLE_LENGTH="${#EIA_API_KEY_VAR}"
          
          echo "Secret EIA_API_KEY length: $SECRET_LENGTH characters"
          echo "Variable EIA_API_KEY length: $VARIABLE_LENGTH characters"
          
          # Determine which one to use
          if [ -n "$EIA_API_KEY_SECRET" ]; then
            echo "âœ… Using EIA_API_KEY from SECRETS"
            echo "   First 8 chars: ${EIA_API_KEY_SECRET:0:8}..."
            echo "   Last 8 chars: ...${EIA_API_KEY_SECRET: -8}"
          elif [ -n "$EIA_API_KEY_VAR" ]; then
            echo "âœ… Using EIA_API_KEY from VARIABLES"
            echo "   First 8 chars: ${EIA_API_KEY_VAR:0:8}..."
            echo "   Last 8 chars: ...${EIA_API_KEY_VAR: -8}"
          else
            echo "âŒ ERROR: No EIA_API_KEY found in secrets or variables!"
            echo ""
            echo "To fix:"
            echo "1. Go to Settings â†’ Secrets and variables â†’ Actions"
            echo "2. Click 'Variables' tab"
            echo "3. Add repository variable: EIA_API_KEY"
            echo "4. Value: z9d4AvwBK6c8FXmei1kasuD849Mz6i5WALqgQyiV"
            exit 1
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        env:
          EIA_API_KEY_SECRET: ${{ secrets.EIA_API_KEY }}
          EIA_API_KEY_VAR: ${{ vars.EIA_API_KEY }}
      
      - name: Run EIA Fuel Mix ETL
        run: |
          echo "ğŸ”„ Running EIA Fuel Mix ETL..."
          # Use variable if secret not set
          export EIA_API_KEY="${EIA_API_KEY_SECRET:-$EIA_API_KEY_VAR}"
          if [ -z "$EIA_API_KEY" ]; then
            echo "âš ï¸  Skipping - No API key available"
            exit 0
          fi
          echo "âœ… API key found: ${EIA_API_KEY:0:8}...${EIA_API_KEY: -8}"
          python etl/eia_fuelmix_etl.py
        env:
          EIA_API_KEY_SECRET: ${{ secrets.EIA_API_KEY }}
          EIA_API_KEY_VAR: ${{ vars.EIA_API_KEY }}
        continue-on-error: true
      
      - name: Run ERCOT Real-Time LMP ETL
        run: |
          echo "ğŸ”„ Running ERCOT Real-Time LMP ETL..."
          python etl/ercot_lmp_etl.py
        continue-on-error: true  # Don't fail if ERCOT API temporarily down
      
      - name: Run EIA Plants ETL (stub)
        run: |
          echo "ğŸ”„ Running EIA Plants ETL..."
          # Use variable if secret not set
          export EIA_API_KEY="${EIA_API_KEY_SECRET:-$EIA_API_KEY_VAR}"
          if [ -z "$EIA_API_KEY" ]; then
            echo "âš ï¸  Skipping - No API key available"
            exit 0
          fi
          echo "âœ… API key found: ${EIA_API_KEY:0:8}...${EIA_API_KEY: -8}"
          python etl/eia_plants_etl.py
        env:
          EIA_API_KEY_SECRET: ${{ secrets.EIA_API_KEY }}
          EIA_API_KEY_VAR: ${{ vars.EIA_API_KEY }}
        continue-on-error: true
      
      - name: Run Interconnection Queue ETL
        run: |
          python etl/ercot_queue_etl.py
        continue-on-error: true  # Don't fail if CDR file issues
      
      - name: Run Minerals ETL
        run: |
          echo "ğŸ”„ Running Minerals ETL..."
          python etl/mineral_etl.py
        continue-on-error: true
      
      - name: Validate data files
        run: |
          echo "âœ… Validating parquet files..."
          python -c "
          import pandas as pd
          from pathlib import Path
          
          data_files = sorted(Path('data').glob('*.parquet'))
          print(f'\nğŸ“Š Found {len(data_files)} data files:\n')
          
          for file in data_files:
              try:
                  df = pd.read_parquet(file)
                  size_kb = file.stat().st_size / 1024
                  print(f'  âœ… {file.name:30s} {len(df):>6,d} rows  {size_kb:>8,.1f} KB')
              except Exception as e:
                  print(f'  âŒ {file.name:30s} ERROR: {e}')
          "
        continue-on-error: true
      
      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code data/ || echo "changes=true" >> $GITHUB_OUTPUT
      
      - name: Commit and push changes
        if: steps.git-check.outputs.changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/*.parquet
          
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          git commit -m "ğŸ¤– Auto-update energy data - $TIMESTAMP

          Updated by GitHub Actions ETL pipeline
          Trigger: ${{ github.event_name }}
          
          Data sources refreshed:
          - EIA Fuel Mix (ERCOT generation by fuel type)
          - EIA Power Plants (Texas generation facilities)
          - ERCOT Queue (interconnection projects)
          - Price Map (demo LMP data)
          - Minerals (REE & critical minerals deposits)
          
          [skip ci]"
          
          git push
      
      - name: ETL Pipeline Summary
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š TAB Energy Dashboard - ETL Pipeline Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Workflow:       ${{ github.workflow }}"
          echo "Trigger:        ${{ github.event_name }}"
          echo "Run Time:       $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "Data Updated:   ${{ steps.git-check.outputs.changes }}"
          echo "Status:         ${{ job.status }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
