name: ETL Data Updates

# Run every 6 hours and allow manual triggering
on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours at :00
  workflow_dispatch:  # Allow manual runs

# Grant write permissions to commit data files
permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Verify EIA API Key
        env:
          EIA_API_KEY: ${{ secrets.EIA_API_KEY }}
        run: |
          if [ -z "$EIA_API_KEY" ]; then
            echo "âŒ ERROR: EIA_API_KEY secret not found!"
            echo "Add it in: Settings > Secrets and variables > Actions"
            exit 1
          fi
          echo "âœ… EIA_API_KEY verified (${#EIA_API_KEY} characters)"
      
      - name: Run EIA Fuel Mix ETL
        env:
          EIA_API_KEY: ${{ secrets.EIA_API_KEY }}
        run: |
          python etl/eia_fuelmix_etl.py
        continue-on-error: true  # Don't fail entire workflow
      
      - name: Run Price Map ETL (demo data)
        run: |
          python etl/price_map_etl.py
        continue-on-error: true  # Don't fail entire workflow
      
      - name: Run EIA Plants ETL (stub)
        env:
          EIA_API_KEY: ${{ secrets.EIA_API_KEY }}
        run: |
          python etl/eia_plants_etl.py
        continue-on-error: true  # Don't fail entire workflow if this fails
      
      - name: Run Interconnection Queue ETL
        run: |
          python etl/ercot_queue_etl.py
        continue-on-error: true  # Don't fail if CDR file issues
      
      - name: Run Minerals ETL
        run: |
          echo "ğŸ”„ Running Minerals ETL..."
          python etl/mineral_etl.py
        continue-on-error: true
      
      - name: Validate data files
        run: |
          echo "âœ… Validating parquet files..."
          python -c "
          import pandas as pd
          from pathlib import Path
          
          data_files = sorted(Path('data').glob('*.parquet'))
          print(f'\nğŸ“Š Found {len(data_files)} data files:\n')
          
          for file in data_files:
              try:
                  df = pd.read_parquet(file)
                  size_kb = file.stat().st_size / 1024
                  print(f'  âœ… {file.name:30s} {len(df):>6,d} rows  {size_kb:>8,.1f} KB')
              except Exception as e:
                  print(f'  âŒ {file.name:30s} ERROR: {e}')
          "
        continue-on-error: true
      
      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code data/ || echo "changes=true" >> $GITHUB_OUTPUT
      
      - name: Commit and push changes
        if: steps.git-check.outputs.changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/*.parquet
          
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          git commit -m "ğŸ¤– Auto-update energy data - $TIMESTAMP

          Updated by GitHub Actions ETL pipeline
          Trigger: ${{ github.event_name }}
          
          Data sources refreshed:
          - EIA Fuel Mix (ERCOT generation by fuel type)
          - EIA Power Plants (Texas generation facilities)
          - ERCOT Queue (interconnection projects)
          - Price Map (demo LMP data)
          - Minerals (REE & critical minerals deposits)
          
          [skip ci]"
          
          git push
      
      - name: ETL Pipeline Summary
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š TAB Energy Dashboard - ETL Pipeline Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Workflow:       ${{ github.workflow }}"
          echo "Trigger:        ${{ github.event_name }}"
          echo "Run Time:       $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "Data Updated:   ${{ steps.git-check.outputs.changes }}"
          echo "Status:         ${{ job.status }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
